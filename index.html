<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Order V3 - Green Grass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .hidden-section {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        .toast-success {
            border-left-color: #10b981;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div id="toast-container"></div>

    <!-- LOGIN PAGE -->
    <div id="login-page"
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-700 to-teal-800 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div
                    class="bg-green-100 text-green-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-tools"></i></div>
                <h1 class="text-2xl font-bold text-gray-800">Green Grass System</h1>
                <p class="text-gray-500 text-sm">V3.0 (Modul Instalasi & SPK)</p>
            </div>
            <form onsubmit="app.handleLogin(event)" class="space-y-4">
                <input type="text" id="username" class="w-full px-4 py-3 border rounded-lg bg-gray-50"
                    placeholder="admin / marketing" required>
                <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg bg-gray-50"
                    placeholder="pass123" required>
                <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg">Masuk
                    Aplikasi</button>
            </form>
            <div class="mt-4 text-center text-xs text-gray-400">Demo: marketing / pass123</div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-layout" class="hidden-section min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside class="bg-white w-full md:w-64 border-r border-gray-200 flex-shrink-0 z-20 shadow-sm">
            <div class="p-6 border-b flex items-center gap-3 bg-green-50">
                <i class="fas fa-leaf text-green-600 text-xl"></i>
                <div>
                    <h2 class="font-bold text-gray-800">Green Grass</h2>
                    <p class="text-xs text-green-600 font-bold" id="role-badge">MARKETING</p>
                </div>
            </div>
            <nav class="p-4 space-y-2">
                <button onclick="app.nav('home')"
                    class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 flex items-center gap-3 transition text-gray-600"><i
                        class="fas fa-home w-5"></i> Dashboard</button>
                <button onclick="app.nav('input')"
                    class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 flex items-center gap-3 transition text-gray-600"><i
                        class="fas fa-plus-circle w-5"></i> Input Pesanan</button>
                <button onclick="app.nav('orders')"
                    class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 flex items-center gap-3 transition text-gray-600"><i
                        class="fas fa-list w-5"></i> Riwayat Transaksi</button>
                <button onclick="app.logout()"
                    class="w-full text-left px-4 py-3 mt-8 rounded-lg text-red-500 hover:bg-red-50 flex items-center gap-3 transition"><i
                        class="fas fa-sign-out-alt w-5"></i> Keluar</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto h-screen bg-gray-50 p-4 md:p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="page-title">Dashboard</h1>
                    <p class="text-sm text-gray-500" id="current-date">Kamis, 28 Nov 2025</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <div class="font-bold text-gray-800" id="user-name">Eneng Eka</div>
                        <div class="text-xs text-green-600">Online</div>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-green-200 text-green-800 flex items-center justify-center font-bold">
                        E</div>
                </div>
            </header>

            <!-- VIEW: HOME -->
            <div id="view-home" class="view-section fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <div class="text-gray-400 text-xs uppercase font-bold mb-1">Pesanan Barang</div>
                        <div class="text-2xl font-bold text-gray-800" id="stat-kp">0</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <div class="text-gray-400 text-xs uppercase font-bold mb-1">Tiket Instalasi (KI)</div>
                        <div class="text-2xl font-bold text-gray-800" id="stat-ki">0</div>
                    </div>
                </div>
                <!-- Action Card -->
                <div onclick="app.nav('input')"
                    class="bg-gradient-to-r from-green-600 to-teal-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:shadow-xl transition flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold mb-1">Buat Pesanan & Instalasi Baru</h3>
                        <p class="text-green-100 text-sm opacity-90">Klik disini untuk input data pelanggan dan SPK
                            Instalasi.</p>
                    </div>
                    <div
                        class="bg-white text-green-700 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow">
                        <i class="fas fa-plus"></i></div>
                </div>
            </div>

            <!-- VIEW: INPUT ORDER V3 -->
            <div id="view-input" class="view-section hidden-section fade-in">
                <form onsubmit="app.submitOrder(event)" class="max-w-6xl mx-auto space-y-6">

                    <!-- 1. DATA PELANGGAN & PESANAN BARANG (KP) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                            <h2 class="font-bold text-blue-800"><i class="fas fa-shopping-cart mr-2"></i>Data Pesanan
                                Barang (KP)</h2>
                            <span
                                class="text-xs bg-white border border-blue-200 px-2 py-1 rounded text-blue-600 font-mono font-bold"
                                id="new-kp-id">KP-AUTO</span>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Customer Info -->
                            <div class="space-y-3">
                                <div><label class="label-input">Nama Pelanggan</label><input type="text" id="inp-cust"
                                        class="input-field" required placeholder="Bpk Pradito"></div>
                                <div><label class="label-input">No. WhatsApp</label><input type="number" id="inp-phone"
                                        class="input-field" required placeholder="08xxx"></div>
                                <div><label class="label-input">Alamat Kirim</label><textarea id="inp-addr" rows="2"
                                        class="input-field" placeholder="Alamat lengkap..."></textarea></div>
                                <div><label class="label-input">Link Maps</label><input type="url" id="inp-maps"
                                        class="input-field text-blue-600" placeholder="https://maps..."></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="label-input">Tgl Kirim Barang</label><input type="date"
                                            id="inp-date-send" class="input-field"></div>
                                    <div><label class="label-input">Sumber Gudang</label><select id="inp-wh"
                                            class="input-field bg-white">
                                            <option>Rainbow</option>
                                            <option>Pusat</option>
                                        </select></div>
                                </div>
                            </div>

                            <!-- Cart Items -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Keranjang Barang</h3>
                                <table class="w-full text-sm mb-3">
                                    <thead>
                                        <tr class="text-left text-xs text-gray-400">
                                            <th class="w-5/12">Produk</th>
                                            <th class="w-2/12">Qty</th>
                                            <th class="w-4/12 text-right">Harga</th>
                                            <th class="w-1/12"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cart-items"></tbody>
                                </table>
                                <button type="button" onclick="app.addCartRow()"
                                    class="text-xs text-blue-600 font-bold hover:underline">+ Tambah Barang</button>

                                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                                    <span class="text-sm font-bold text-gray-500">Subtotal Barang:</span>
                                    <span class="text-lg font-bold text-gray-800" id="total-goods">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. TOGGLE INSTALASI -->
                    <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div
                            class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-install"
                                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" />
                            <label for="toggle-install"
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Sertakan Jasa Instalasi / Pemasangan?</h3>
                            <p class="text-xs text-gray-500">Aktifkan ini untuk membuat Tiket Instalasi (KI) secara
                                otomatis.</p>
                        </div>
                    </div>

                    <!-- 3. FORM INSTALASI (KI) - Hidden by default -->
                    <div id="section-install"
                        class="hidden-section bg-orange-50 rounded-xl shadow-sm border border-orange-200 overflow-hidden fade-in">
                        <div class="p-4 bg-orange-100 border-b border-orange-200 flex justify-between items-center">
                            <h2 class="font-bold text-orange-800"><i class="fas fa-hard-hat mr-2"></i>Form Instalasi
                                (KI)</h2>
                            <span
                                class="text-xs bg-white border border-orange-300 px-2 py-1 rounded text-orange-600 font-mono font-bold"
                                id="new-ki-id">KI-AUTO</span>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <div><label class="label-input">Nama Mandor / PIC Lapangan</label><input type="text"
                                        id="inp-mandor" class="input-field bg-white" placeholder="Contoh: Mang Ayi">
                                </div>
                                <div><label class="label-input">Tanggal Pengerjaan (Install)</label><input type="date"
                                        id="inp-date-install" class="input-field bg-white"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex gap-4">
                                    <div class="w-1/2">
                                        <label class="label-input">Luas Area (m²)</label>
                                        <input type="number" id="inp-install-qty" oninput="app.calcInstall()"
                                            class="input-field bg-white" placeholder="0">
                                    </div>
                                    <div class="w-1/2">
                                        <label class="label-input">Biaya Jasa per m²</label>
                                        <input type="number" id="inp-install-price" oninput="app.calcInstall()"
                                            class="input-field bg-white" value="35000">
                                    </div>
                                </div>
                                <div>
                                    <label class="label-input">Total Biaya Pasang</label>
                                    <input type="text" id="inp-install-total"
                                        class="input-field bg-orange-100 font-bold text-orange-800" readonly
                                        value="Rp 0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. FOOTER & PEMBAYARAN -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="w-full md:w-1/3">
                            <label class="label-input">Total Tagihan (Barang + Jasa)</label>
                            <div class="text-2xl font-bold text-green-700" id="grand-total">Rp 0</div>
                        </div>
                        <div class="w-full md:w-1/3">
                            <label class="label-input">Status Pembayaran</label>
                            <select id="inp-pay" class="input-field">
                                <option>Belum Bayar</option>
                                <option>DP</option>
                                <option>Lunas</option>
                            </select>
                        </div>
                        <div class="w-full md:w-auto flex gap-2">
                            <button type="button" onclick="app.nav('home')"
                                class="px-6 py-3 rounded-lg border hover:bg-gray-50 text-gray-600 font-bold">Batal</button>
                            <button type="submit"
                                class="px-6 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg flex items-center gap-2">
                                <i class="fas fa-save"></i> Simpan Transaksi
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- VIEW: LIST ORDERS -->
            <div id="view-orders" class="view-section hidden-section fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="font-bold text-lg mb-4">Riwayat Transaksi</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase font-bold text-xs">
                                <tr>
                                    <th class="px-4 py-3">Kode Pesanan (KP)</th>
                                    <th class="px-4 py-3">Kode Instalasi (KI)</th>
                                    <th class="px-4 py-3">Pelanggan</th>
                                    <th class="px-4 py-3 text-right">Total</th>
                                    <th class="px-4 py-3 text-center">Status</th>
                                    <th class="px-4 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-orders" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL WA -->
    <div id="modal-wa"
        class="hidden-section fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden fade-in">
            <div class="p-4 border-b bg-green-50 flex justify-between items-center">
                <h3 class="font-bold text-green-800">Format WhatsApp</h3>
                <button onclick="document.getElementById('modal-wa').classList.add('hidden-section')"
                    class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4"><textarea id="wa-content" rows="15"
                    class="w-full p-3 border rounded-lg bg-gray-50 font-mono text-sm focus:outline-none"
                    readonly></textarea></div>
            <div class="p-4 border-t flex justify-end gap-2">
                <button onclick="app.copyToClipboard()"
                    class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"><i
                        class="fas fa-copy"></i> Salin Teks</button>
            </div>
        </div>
    </div>

    <script>
        // CSS Utility Classes injected via JS for cleaner HTML
        const style = document.createElement('style');
        style.innerHTML = `
            .label-input { display: block; font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem; text-transform: uppercase; }
            .input-field { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; outline: none; transition: all 0.2s; }
            .input-field:focus { ring: 2px; ring-color: #10b981; border-color: #10b981; }
        `;
        document.head.appendChild(style);

        const app = {
            products: [
                { id: 'P01', name: 'Swiss Platinum 4cm', unit: 'm²', price: 210000, fee: 10500, fee_code: 'R' },
                { id: 'P02', name: 'Drainase Cell', unit: 'm²', price: 105000, fee: 3000, fee_code: 'Dc' },
                { id: 'P04', name: 'Pasir Silika', unit: 'Sak', price: 50000, fee: 2000, fee_code: 'Ps' }
            ],
            orders: [],

            init: function () {
                const saved = localStorage.getItem('gg_orders_v3');
                if (saved) this.orders = JSON.parse(saved);

                // Set Default Dates
                document.getElementById('inp-date-send').valueAsDate = new Date();
                document.getElementById('inp-date-install').valueAsDate = new Date();

                // Toggle Logic
                document.getElementById('toggle-install').addEventListener('change', (e) => {
                    const section = document.getElementById('section-install');
                    if (e.target.checked) {
                        section.classList.remove('hidden-section');
                        this.generateKI();
                    } else {
                        section.classList.add('hidden-section');
                        // Reset install values
                        document.getElementById('inp-install-qty').value = '';
                        this.calcInstall();
                    }
                    this.calcGrandTotal();
                });

                this.addCartRow();
            },

            handleLogin: function (e) {
                e.preventDefault();
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if (p === 'pass123') {
                    document.getElementById('login-page').classList.add('hidden-section');
                    document.getElementById('dashboard-layout').classList.remove('hidden-section');
                    this.setupUI();
                } else { alert('Login Gagal'); }
            },

            logout: function () { location.reload(); },

            setupUI: function () {
                this.nav('home');
                this.updateStats();
            },

            nav: function (page) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
                if (page === 'home') {
                    document.getElementById('view-home').classList.remove('hidden-section');
                    this.updateStats();
                } else if (page === 'input') {
                    document.getElementById('view-input').classList.remove('hidden-section');
                    this.generateKP();
                } else if (page === 'orders') {
                    document.getElementById('view-orders').classList.remove('hidden-section');
                    this.renderOrders();
                }
            },

            // --- GENERATOR KODE ---
            formatDateCode: function (dateStr) {
                // Input: 2025-11-28 -> Output: 281125
                const d = new Date(dateStr);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = String(d.getFullYear()).substr(-2);
                return `${day}${month}${year}`;
            },

            generateKP: function () {
                const dateCode = this.formatDateCode(document.getElementById('inp-date-send').value);
                const count = this.orders.length + 1;
                document.getElementById('new-kp-id').innerText = `KP-${dateCode}-${String(count).padStart(2, '0')}`;
            },

            generateKI: function () {
                const dateCode = this.formatDateCode(document.getElementById('inp-date-install').value);
                // Hitung berapa order yg punya instalasi
                const count = this.orders.filter(o => o.ki_id !== '-').length + 1;
                document.getElementById('new-ki-id').innerText = `KI-${dateCode}-${String(count).padStart(2, '0')}`;
            },

            // --- CART LOGIC ---
            addCartRow: function () {
                const tbody = document.getElementById('cart-items');
                const rowId = Date.now();
                let options = `<option value="">-- Pilih --</option>`;
                this.products.forEach(p => options += `<option value="${p.id}">${p.name}</option>`);

                const tr = document.createElement('tr');
                tr.id = `row-${rowId}`;
                tr.innerHTML = `
                    <td class="pr-2 pb-2"><select class="input-field item-select" onchange="app.calcGoods()">${options}</select></td>
                    <td class="pr-2 pb-2"><input type="number" class="input-field item-qty" value="1" min="1" oninput="app.calcGoods()"></td>
                    <td class="pr-2 pb-2"><input type="text" class="input-field item-total bg-gray-100 text-right" readonly value="0"></td>
                    <td class="pb-2 text-center"><button type="button" onclick="document.getElementById('row-${rowId}').remove(); app.calcGoods()" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            },

            calcGoods: function () {
                let total = 0;
                let feeR = 0; let feeDc = 0;
                document.querySelectorAll('#cart-items tr').forEach(row => {
                    const pid = row.querySelector('.item-select').value;
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const prod = this.products.find(p => p.id === pid);

                    if (prod) {
                        const sub = prod.price * qty;
                        row.querySelector('.item-total').value = sub.toLocaleString('id-ID');
                        total += sub;
                        if (prod.fee_code === 'R') feeR += (prod.fee * qty);
                        if (prod.fee_code === 'Dc') feeDc += (prod.fee * qty);
                    }
                });
                document.getElementById('total-goods').innerText = "Rp " + total.toLocaleString('id-ID');
                document.getElementById('total-goods').dataset.val = total;
                document.getElementById('total-goods').dataset.feeR = feeR;
                document.getElementById('total-goods').dataset.feeDc = feeDc;
                this.calcGrandTotal();
            },

            calcInstall: function () {
                const qty = parseFloat(document.getElementById('inp-install-qty').value) || 0;
                const price = parseFloat(document.getElementById('inp-install-price').value) || 0;
                const total = qty * price;
                document.getElementById('inp-install-total').value = "Rp " + total.toLocaleString('id-ID');
                document.getElementById('inp-install-total').dataset.val = total;
                this.calcGrandTotal();
            },

            calcGrandTotal: function () {
                const goods = parseFloat(document.getElementById('total-goods').dataset.val) || 0;
                const install = document.getElementById('toggle-install').checked ? (parseFloat(document.getElementById('inp-install-total').dataset.val) || 0) : 0;
                const grand = goods + install;
                document.getElementById('grand-total').innerText = "Rp " + grand.toLocaleString('id-ID');
                return { goods, install, grand };
            },

            // --- SUBMIT ---
            submitOrder: function (e) {
                e.preventDefault();
                const totals = this.calcGrandTotal();
                const hasInstall = document.getElementById('toggle-install').checked;

                // Gather Cart Items
                const items = [];
                document.querySelectorAll('#cart-items tr').forEach(row => {
                    const pid = row.querySelector('.item-select').value;
                    const qty = row.querySelector('.item-qty').value;
                    const prod = this.products.find(p => p.id === pid);
                    if (prod) items.push({ name: prod.name, qty: qty, price: prod.price, sub: prod.price * qty, unit: prod.unit });
                });

                if (items.length === 0) return alert('Keranjang barang kosong!');

                const newOrder = {
                    kp_id: document.getElementById('new-kp-id').innerText,
                    ki_id: hasInstall ? document.getElementById('new-ki-id').innerText : '-',
                    customer: document.getElementById('inp-cust').value,
                    phone: document.getElementById('inp-phone').value,
                    address: document.getElementById('inp-addr').value,
                    maps: document.getElementById('inp-maps').value,
                    date_send: document.getElementById('inp-date-send').value,
                    wh: document.getElementById('inp-wh').value,
                    items: items,
                    install_info: hasInstall ? {
                        mandor: document.getElementById('inp-mandor').value,
                        date: document.getElementById('inp-date-install').value,
                        qty: document.getElementById('inp-install-qty').value,
                        price: document.getElementById('inp-install-price').value,
                        total: totals.install
                    } : null,
                    totals: totals,
                    fees: {
                        r: document.getElementById('total-goods').dataset.feeR,
                        dc: document.getElementById('total-goods').dataset.feeDc
                    },
                    pay_status: document.getElementById('inp-pay').value
                };

                this.orders.unshift(newOrder);
                localStorage.setItem('gg_orders_v3', JSON.stringify(this.orders));

                this.showWAFormat(newOrder);
                alert('Transaksi Disimpan!');
                // Reset simple
                setTimeout(() => location.reload(), 2000);
            },

            // --- WA FORMATTER V3 ---
            showWAFormat: function (order) {
                let itemsTxt = '';
                order.items.forEach((i, idx) => {
                    itemsTxt += `${idx + 1}️⃣ ${i.name}\n${i.qty}${i.unit} x ${i.price.toLocaleString()} = ${i.sub.toLocaleString()}\n`;
                });

                let installTxt = '';
                if (order.ki_id !== '-') {
                    installTxt = `3️⃣ Jasa Pemasangan\n${order.install_info.qty}m² x ${parseInt(order.install_info.price).toLocaleString()} = ${order.install_info.total.toLocaleString()}\n`;
                }

                const format = `*Format Pemesanan*
_Project by ${document.getElementById('user-name').innerText}_

*${order.kp_id}* ${order.ki_id !== '-' ? '\n*' + order.ki_id + '*' : ''}

Nama : ${order.customer}
${order.ki_id !== '-' ? 'Nama Mandor : ' + order.install_info.mandor : ''}
No : ${order.phone}
Alamat : ${order.address} ${order.maps}

*Rincian :*
${itemsTxt}${installTxt}
*Total Pembayaran Rp ${order.totals.grand.toLocaleString()}*

Pengiriman : Dari ${order.wh}
Fee R : ${parseInt(order.fees.r).toLocaleString()}
Fee Dc : ${parseInt(order.fees.dc).toLocaleString()}`;

                document.getElementById('wa-content').value = format;
                document.getElementById('modal-wa').classList.remove('hidden-section');
            },

            copyToClipboard: function () {
                document.getElementById('wa-content').select();
                document.execCommand('copy');
                alert('Teks tersalin!');
            },

            renderOrders: function () {
                const tbody = document.getElementById('table-orders');
                tbody.innerHTML = '';
                this.orders.forEach(o => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3 font-mono font-bold text-blue-600">${o.kp_id}</td>
                            <td class="px-4 py-3 font-mono font-bold text-orange-600">${o.ki_id}</td>
                            <td class="px-4 py-3">${o.customer}</td>
                            <td class="px-4 py-3 text-right">Rp ${o.totals.grand.toLocaleString()}</td>
                            <td class="px-4 py-3 text-center text-xs font-bold bg-green-100 text-green-700 rounded">${o.pay_status}</td>
                            <td class="px-4 py-3 text-center"><button onclick='app.showWAFormat(${JSON.stringify(o)})' class="text-blue-600"><i class="fab fa-whatsapp"></i></button></td>
                        </tr>
                    `;
                });
            },

            updateStats: function () {
                document.getElementById('stat-kp').innerText = this.orders.length;
                document.getElementById('stat-ki').innerText = this.orders.filter(o => o.ki_id !== '-').length;
            }
        };

        // Auto Load
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>